var myApp=angular.module("roomie",["roomie.auth","roomie.services","roomie.main","roomie.contact","roomie.angularfireChatController","roomie.ProfileController","roomie.angularfireChatFactory","roomie.angularfireUsersFactory","ui.router","ngMaterial","ngAria","ngAnimate","ngMessages","angular-md5","firebase","ngTouch"]).config(["$stateProvider","$urlRouterProvider","$httpProvider",function(a,b,c){b.otherwise("/"),a.state("home",{templateUrl:"app/home/homepage.html",url:"/",controller:"AuthController"}).state("signin",{templateUrl:"app/auth/login.html",url:"/login",controller:"AuthController"}).state("socialsignup",{templateUrl:"app/auth/socialsignup.html",url:"/socialsignup",controller:"AuthController"}).state("signup",{templateUrl:"app/auth/signup.html",url:"/signup",controller:"AuthController"}).state("profile",{templateUrl:"app/profile/profile.html",url:"/profile",controller:"myProfileController",authenticate:!0}).state("profileEdit",{templateUrl:"app/profile/editprofile.html",url:"/edit",controller:"EditProfileController as editProfileController",authenticate:!0}).state("contact",{templateUrl:"app/contact/contact.html",url:"/contact",controller:"ContactController as contactController",resolve:{auth:function(a,b,c){return console.log("PROFILE: checking if the user is authenticated..."),c.auth.$requireAuth()["catch"](function(){console.log("user is NOT authenticated so we are going HOME"),a.go("signin")})},profile:function(a,b,c){return b.auth.$requireAuth().then(function(b){return console.log("attempting to resolve contact auth promise...",b),c.getProfile(b.uid).$loaded().then(function(b){return console.log("contact auth promise was able to resolve the getProfile..."),console.log("profile: ",b),b.displayName?(console.log("returning the profile!",b),b):(console.log("user has no displayName so heading to PROFILE"),void a.go("profilepage"))})},function(b){console.log("User is not Authenticated so we cannot get her profile. Heading to HOME"),a.go("signin")})}},authenticate:!0}).state("chat",{templateUrl:"app/chat/chat.html",url:"/chat",controller:"ContactController as contactController",resolve:{auth:function(a,b,c){return console.log("PROFILE: checking if the user is authenticated..."),c.auth.$requireAuth()["catch"](function(){console.log("user is NOT authenticated so we are going HOME"),a.go("signin")})},profile:function(a,b,c){return b.auth.$requireAuth().then(function(b){return console.log("attempting to resolve contact auth promise...",b),c.getProfile(b.uid).$loaded().then(function(b){return console.log("contact auth promise was able to resolve the getProfile..."),console.log("profile: ",b),b.displayName?(console.log("returning the profile!",b),b):(console.log("user has no displayName so heading to PROFILE"),void a.go("profilepage"))})},function(b){console.log("User is not Authenticated so we cannot get her profile. Heading to HOME"),a.go("signin")})}},authenticate:!0}).state("chat.direct",{templateUrl:"app/chat/messages.html",url:"/{uid}/messages/direct",controller:"MessagesCtrl as messagesCtrl",resolve:{messages:function(a,b,c){return console.log("looking for the messages in direct! ",b),b.forUsers(a.uid,c.$id).$loaded()},channelName:function(a,b){return b.all.$loaded().then(function(){return"@"+b.getDisplayNames(a.uid)})}},authenticate:!0}).state("main",{templateUrl:"app/main/main.html",url:"/main",controller:"MainController",authenticate:!0}).state("sociallogin",{templateUrl:"app/profile/createSocialProfile.html",url:"/createprofile",controller:"SocialProfileController as socialProfileController",resolve:{auth:function(a,b,c){return console.log("PROFILE: checking if the user is authenticated..."),c.auth.$requireAuth()["catch"](function(){console.log("user is NOT authenticated so we are going HOME"),a.go("signup")})}}}),c.interceptors.push("AttachTokens")}]).factory("AttachTokens",["$window",function(a){var b={request:function(b){var c=a.localStorage.getItem("com.roomie");return c&&(b.headers["x-access-token"]=c),b.headers["Allow-Control-Allow-Origin"]="*",b}};return b}]).run(["$rootScope","$state","Auth",function(a,b,c){a.$on("$stateChangeStart",function(a,d,e,f,g,h){d&&d.authenticate&&!c.isAuth()&&(a.preventDefault(),b.go("login"))})}]).constant("FirebaseUrl","https://instaroomie.firebaseio.com/");angular.module("roomie.auth",[]).controller("AuthController",["$scope","$window","$state","Auth","Users","md5","$mdDialog","$mdMedia",function(a,b,c,d,e,f,g,h){a.user={},a.signup=function(){console.log("This was sent from the auth controller ",a.user),a.firebaseUser={email:a.user.email,password:a.user.password},d.auth.$createUser(a.firebaseUser).then(function(b){e.getProfile(b.uid).$loaded().then(function(b){a.profile=b,a.profile.displayName=a.user.username,a.profile.emailHash=f.createHash(a.firebaseUser.email),console.log("this is the profile after it gets the displayname and email hash ",a.profile),d.auth.$authWithPassword(a.firebaseUser).then(function(b){console.log(b," is logged in!"),a.profile.$save().then(function(){console.log("profile successfully saved")})})})},function(b){console.log("This is the error from Firebase ",b),a.error=b}),d.signup(a.user).then(function(a){b.localStorage.setItem("com.roomie",a),c.go("main")})["catch"](function(a){console.error(a)})},a.signin=function(){a.firebaseUser={email:a.user.email,password:a.user.password},d.auth.$authWithPassword(a.firebaseUser).then(function(a){console.log(a," is logged in!")},function(a){console.log("This is the error from Firebase ",a)}),d.signin(a.user).then(function(a){b.localStorage.setItem("com.roomie",a),c.go("main")})["catch"](function(b){console.log("this is the error from the server: ",b.data.error),a.error=b.data.error})},a.login=function(a){d.auth.$authWithOAuthPopup(a).then(function(a){d.signin(a).then(function(a){a?(b.localStorage.setItem("com.roomie",a),c.go("main")):(console.log("social user does not exist"),c.go("sociallogin"))})})["catch"](function(b){"TRANSPORT_UNAVAILABLE"===b.code?d.auth.$authWithOAuthPopup(a).then(function(a){}):console.log(b)})},a.goLogin=function(){c.go("signin")},a.goSignUp=function(a){var b=g.confirm().title("Do you have a Twitter, Facebook, GitHub, or Google account?").textContent("").ariaLabel("Social Sign Up").targetEvent(a).ok("Yep").cancel("No");g.show(b).then(function(){c.go("socialsignup")},function(){c.go("signup")})}}]),angular.module("roomie.angularfireChatController",[]).controller("MessagesCtrl",["$scope","profile","channelName","messages",function(a,b,c,d){var e=this;e.messages=d,e.channelName=c,e.message="",e.sendMessage=function(){e.message.length>0&&e.messages.$add({uid:b.$id,body:e.message,timestamp:Firebase.ServerValue.TIMESTAMP}).then(function(){e.message=""})},a.signout=function(){Auth.auth.$unauth(),Auth.signout()},a["new"]=function(){$state.go("main")},a.contacts=function(){$state.go("contact")},a.profile=function(){$state.go("profile")}}]),angular.module("roomie.contact",[]).controller("ContactController",["$scope","$state","State","profile","auth","Users","Auth","md5",function(a,b,c,d,e,f,g,h){var i=this;i.friendPhoto={},i.getContact=function(){c.getContact().then(function(a){i.data=a,_.each(a,function(a){_.each(i.users,function(b){b.$id;h.createHash(a.email)===b.emailHash&&(_.extend(a,b),_.extend(i.friendPhoto,{id:a.image_url}))})}),console.log("This is the contact controller stuff ",i)})},i.profilepage=function(){b.go("profile")},i.getUser=function(){c.getUser().then(function(a){i.profile.$id;i.user=a[0],_.extend(i.friendPhoto,{profileId:i.user.image_url})})},i.profile=d,f.setOnline(d.$id),i.getDisplayName=f.getDisplayNames,i.getGravatar=f.gravatar,i.users=f.all,i.getProfileImage=function(a){return i.friendPhoto[a]},i.signout=function(){g.auth.$unauth(),g.signout()},i["new"]=function(){b.go("main")},i["new"]=function(){b.go("main")},i.contacts=function(){b.go("contact")},i.getUser(),i.getContact()}]),angular.module("roomie.main",[]).controller("MainController",["$scope","$mdMedia","State","$window","$state","Auth",function(a,b,c,d,e,f){a.data,a.currentuser=f.currentuser,a.dataArray=[],a.user,a.profile=function(){e.go("profile")},a.seenAllTruth=function(){var a=!1;return c.seenAllTruth()===!0&&(a=!0),a},a.getUser=function(){c.getUser().then(function(b){a.user=b[0]})},a.getData=function(){c.getData().then(function(b){b.length<1?console.log("You've seen all the roomies!"):(a.dataArray=b,a.data=a.dataArray[0])})},a.signout=function(){f.auth.$unauth(),f.signout()},a["new"]=function(){e.go("main")},a.contacts=function(){e.go("contact")},a.approve=function(){c.approve(a.data).then(function(){a.dataArray.shift(),a.dataArray.length<1&&a.getData(),a.data=a.dataArray[0]})},a.decline=function(){c.decline(a.data).then(function(b){a.dataArray.shift(),a.dataArray.length<1&&a.getData(),a.data=a.dataArray[0]})},a.getData(),a.getUser()}]),angular.module("roomie.ProfileController",[]).controller("EditProfileController",["$scope","$mdMedia","State","$window","$state","Auth",function(a,b,c,d,e,f){var g=this;g.user,g.newinfo={},g.editProfile=function(){console.log("edit profile is being sent! ",g.newinfo),c.updateProfile(g.newinfo)},g.getUser=function(){c.getUser().then(function(a){g.user=a[0]})},a.$watch("editProfileController.user.firstname",function(a){g.newinfo.firstname=a}),a.$watch("editProfileController.user.lastname",function(a){g.newinfo.lastname=a}),a.$watch("editProfileController.user.image_url",function(a){g.newinfo.image_url=a}),a.$watch("editProfileController.user.about_me",function(a){g.newinfo.about_me=a}),g.profile=function(){e.go("profile")},g.signout=function(){f.auth.$unauth(),f.signout()},g["new"]=function(){e.go("main")},g.contacts=function(){e.go("contact")},g.getUser()}]).controller("myProfileController",["$scope","$mdMedia","State","$window","$state","Auth",function(a,b,c,d,e,f){a.data,a.currentuser=f.currentuser,a.dataArray=[],a.user,a.resetnos=function(){c.resetNos()},a.updateprofile=function(){e.go("profileEdit")},a.profile=function(){e.go("profile")},a.seenAllTruth=function(){var a=!1;return c.seenAllTruth()===!0&&(a=!0),a},a.getUser=function(){c.getUser().then(function(b){a.user=b[0]})},a.getData=function(){c.getData().then(function(b){b.length<1?console.log("You've seen all the roomies!"):(a.dataArray=b,a.data=a.dataArray[0])})},a.signout=function(){f.auth.$unauth(),f.signout()},a["new"]=function(){e.go("main")},a.contacts=function(){e.go("contact")},a.approve=function(){c.approve(a.data).then(function(){a.dataArray.shift(),a.dataArray.length<1&&a.getData(),a.data=a.dataArray[0]})},a.decline=function(){c.decline(a.data).then(function(b){a.dataArray.shift(),a.dataArray.length<1&&a.getData(),a.data=a.dataArray[0]})},a.getData(),a.getUser()}]).controller("SocialProfileController",["$scope","$mdMedia","State","$window","$state","Auth","auth","Users","md5",function(a,b,c,d,e,f,g,h,i){var j=this;j.newinfo={},console.log("auth in social profile controller",g),f.auth.$onAuth(function(a){null===a?console.log("Not logged in yet"):(j.newinfo.uid=a.uid,console.log("Logged in as",a.uid),console.log("this is the provider ",a.provider)),"twitter"===a.provider&&(j.authData=a.twitter),"github"===a.provider&&(j.authData=a.github),"google"===a.provider&&(j.authData=a.google),"facebook"===a.provider&&(j.authData=a.facebook)}),j.createUser=function(){j.firebaseUser={email:j.newinfo.email,password:j.newinfo.password},f.signup(j.newinfo).then(function(a){h.getProfile(g.uid).$loaded().then(function(b){j.profile=b,j.profile.displayName=j.newinfo.username,j.profile.emailHash=i.createHash(j.newinfo.email),console.log("this is the profile after it gets the displayname and email hash ",j.profile),j.profile.$save().then(function(){console.log("profile successfully saved"),d.localStorage.setItem("com.roomie",a),e.go("main")})})})["catch"](function(a){console.log(a.data),j.error=a.data,j.error.message="That email exists already - did you create one already?",console.log("This is the socialProfileController.error ",j.error)})},a.$watch("socialProfileController.authData.displayName",function(a){j.newinfo.firstname=a}),a.$watch("socialProfileController.authData.profileImageURL",function(a){j.newinfo.image_url=a}),a.$watch("socialProfileController.authData.email",function(a){j.newinfo.email=a}),a.$watch("socialProfileController.authData.username",function(a){j.newinfo.username=a}),j.signout=function(){f.auth.$unauth(),f.signout()}}]),angular.module("roomie.angularfireChatFactory",[]).factory("Messages",["$firebaseArray","FirebaseUrl",function(a,b){var c=new Firebase(b+"channelMessages"),d=new Firebase(b+"userMessages");return{forChannel:function(b){return a(c.child(b))},forUsers:function(b,c){var e=c>b?b+"/"+c:c+"/"+b;return a(d.child(e))}}}]),angular.module("roomie.services",[]).factory("Auth",["$http","$state","$window","$firebaseAuth","FirebaseUrl",function(a,b,c,d,e){var f,g=new Firebase(e),h=d(g),i=function(b){return a({method:"POST",url:"api/users/signup",data:b}).then(function(a){return a.data.token})},j=function(b){return a({method:"POST",url:"api/users/signin",data:b}).then(function(a){return a.data.token})},k=function(){return!!c.localStorage.getItem("com.roomie")},l=function(){c.localStorage.removeItem("com.roomie"),b.go("signin")};return{signup:i,signin:j,isAuth:k,signout:l,auth:h,currentuser:f}}]).factory("State",["$http","$location","$window","Auth",function(a,b,c,d){var e=!1,f=function(){return e},g=function(){return a({method:"GET",url:"api/users/reset"}).then(function(a){console.log(a)})},h=function(){return a({method:"GET",url:"api/users/user"}).then(function(a){return console.log("this is the signedin profile",a.data),a.data})},i=function(){return a({method:"GET",url:"api/users/main"}).then(function(a){return console.log("inside getData",a.data),0===a.data.length&&(e=!0),a.data})},j=function(b){return a({method:"POST",url:"api/profile/yes",data:b}).then(function(a){return a.data})},k=function(b){return a({method:"POST",url:"api/profile/no",data:b}).then(function(a){return a.data})},l=function(){return a({method:"GET",url:"api/contact/friend"}).then(function(a){return console.log(a),a.data})},m=function(b){return a({method:"POST",url:"api/users/update",data:b}).then(function(a){console.log(a)})};return{getData:i,approve:j,decline:k,getContact:l,seenAllTruth:f,getUser:h,resetNos:g,updateProfile:m}}]),angular.module("roomie.angularfireUsersFactory",[]).factory("Users",["$firebaseArray","$firebaseObject","FirebaseUrl",function(a,b,c){var d=new Firebase(c+"users"),e=a(d),f=new Firebase(c+".info/connected"),g={getProfile:function(a){return b(d.child(a))},getDisplayNames:function(a){return e.$getRecord(a).displayName},all:e,gravatar:function(a){return"//www.gravatar.com/avatar/"+e.$getRecord(a).emailHash},setOnline:function(c){var e=b(f),g=a(d.child(c+"/online"));e.$watch(function(){e.$value===!0&&g.$add(!0).then(function(a){a.onDisconnect().remove()})})}};return g}]);